<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#060a12">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<title>COMMS INTERFACE</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png">
<link rel="apple-touch-icon" href="icon-192x192.png">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Oswald:wght@300;500;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  html, body {
    height: 100%; width: 100%;
    background: #060a12;
    color: #c8d0e0;
    font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
    overflow: hidden;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }

  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }
  @keyframes fadeSlideIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

  ::-webkit-scrollbar { width: 3px; }
  ::-webkit-scrollbar-track { background: #0a0e17; }
  ::-webkit-scrollbar-thumb { background: #1a2540; border-radius: 2px; }

  .scanline-overlay {
    position: fixed; inset: 0; z-index: 100; pointer-events: none;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
  }

  /* HEADER */
  .header {
    border-bottom: 1px solid #141c2e;
    padding: 8px 14px;
    display: flex; justify-content: space-between; align-items: center;
    background: linear-gradient(180deg, #0c1018 0%, #080c14 100%);
    flex-shrink: 0;
  }
  .header-left { display: flex; align-items: center; gap: 10px; }
  .header-dot {
    width: 9px; height: 9px; border-radius: 50%; background: #00ff88;
    box-shadow: 0 0 10px #00ff8860, 0 0 20px #00ff8830;
    animation: pulse 3s ease-in-out infinite;
  }
  .header-title { font-size: 13px; font-weight: 700; color: #e0e6f0; letter-spacing: 0.15em; }
  .header-sub { font-size: 8px; color: #4a5578; letter-spacing: 0.12em; margin-top: 1px; }
  .header-right { display: flex; align-items: center; gap: 14px; }
  .header-time { font-size: 13px; font-weight: 600; color: #00d4ff; letter-spacing: 0.06em; text-align: right; }
  .header-utc { font-size: 7px; color: #4a5578; letter-spacing: 0.1em; }
  .header-badge {
    padding: 3px 8px; border: 1px solid #00ff8840; border-radius: 3px;
    font-size: 8px; font-weight: 600; color: #00ff88; letter-spacing: 0.12em; background: #00ff8808;
  }

  .app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; }
  .main { display: flex; flex: 1; overflow: hidden; }

  /* CHANNELS */
  .channels-panel { flex: 1; padding: 10px 12px; overflow-y: auto; }
  .section-label-bar {
    font-size: 8px; font-weight: 600; color: #4a5578; letter-spacing: 0.15em;
    margin-bottom: 8px; display: flex; align-items: center; gap: 8px;
  }
  .section-label-bar .line { flex: 1; height: 1px; background: #141c2e; }

  .channel-card {
    background: linear-gradient(135deg, #0a0e17 0%, #0f1520 100%);
    border: 1px solid #1a2035; border-radius: 6px;
    padding: 10px 12px; position: relative; overflow: hidden;
    transition: border-color 0.3s ease; margin-bottom: 5px;
  }
  .channel-card.active { border-color: var(--ch-color-dim); }
  .channel-card .accent {
    position: absolute; top: 0; left: 0; right: 0; height: 1px;
    background: linear-gradient(90deg, transparent, var(--ch-color-dim), transparent);
  }
  .ch-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;
    flex-wrap: wrap; gap: 4px;
  }
  .ch-left { display: flex; align-items: center; gap: 7px; }
  .ch-right { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .status-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--ch-color); box-shadow: 0 0 4px var(--ch-color-dim);
  }
  .status-dot.active {
    box-shadow: 0 0 8px var(--ch-color), 0 0 16px var(--ch-color-dim);
    animation: pulse 2s ease-in-out infinite;
  }
  .codename {
    font-size: 12px; font-weight: 700; color: var(--ch-color);
    letter-spacing: 0.05em;
  }
  .codename.glow { text-shadow: 0 0 10px var(--ch-color-dim); }
  .mic-btn {
    background: #ffffff10; border: 1px solid #ffffff20; border-radius: 4px;
    padding: 2px 7px; color: #ffffff60; font-family: 'JetBrains Mono', monospace;
    font-size: 8px; font-weight: 600; cursor: pointer; letter-spacing: 0.1em;
    transition: all 0.2s ease;
  }
  .mic-btn.live { background: #ff336630; border-color: #ff3366; color: #ff3366; }
  .ch-meta { font-family: 'JetBrains Mono', monospace; font-size: 8px; letter-spacing: 0.08em; }
  .ch-freq { color: #ffffff30; }
  .ch-role { color: var(--ch-color-dim); }
  .waveform-wrap { position: relative; width: 100%; height: 44px; }
  .waveform-wrap canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
  .level-meter { margin-top: 5px; height: 2px; background: #0a0e14; border-radius: 1px; overflow: hidden; }
  .level-fill {
    height: 100%; border-radius: 1px; transition: width 0.05s linear;
    background: linear-gradient(90deg, var(--ch-color-dim), var(--ch-color));
  }
  .separator { height: 1px; margin: 6px 0; background: linear-gradient(90deg, transparent, #ff336630, transparent); }

  /* LOG PANEL */
  .log-panel {
    width: 280px; border-left: 1px solid #141c2e; background: #070b13;
    display: flex; flex-direction: column; flex-shrink: 0;
  }
  .log-header {
    padding: 8px 12px; border-bottom: 1px solid #141c2e;
    font-size: 8px; font-weight: 600; color: #4a5578; letter-spacing: 0.15em;
    display: flex; justify-content: space-between; align-items: center;
  }
  .log-blink { animation: blink 1.5s step-end infinite; color: #00ff88; }
  .log-body { flex: 1; overflow-y: auto; padding: 6px 0; }

  .log-entry {
    padding: 5px 12px; margin-bottom: 1px;
    border-left: 2px solid var(--log-color);
    animation: fadeSlideIn 0.3s ease;
  }
  .log-top { display: flex; justify-content: space-between; margin-bottom: 1px; }
  .log-from { font-size: 9px; font-weight: 700; letter-spacing: 0.05em; }
  .log-time { font-size: 7px; color: #3a4560; }
  .log-msg { font-size: 9px; color: #8090b0; line-height: 1.35; }
  .log-redacted {
    font-size: 8px; color: #ff6b3580; font-style: italic; letter-spacing: 0.06em;
    margin-top: 2px;
  }
  .redact-bar {
    display: inline-block; background: #ffffff08; border-radius: 2px;
    padding: 0 4px; color: #3a4560; font-size: 8px; letter-spacing: 0.04em;
    border: 1px solid #1a203520;
  }

  .log-footer {
    border-top: 1px solid #141c2e; padding: 6px 12px;
    display: flex; justify-content: space-between;
    font-size: 7px; color: #3a4560; letter-spacing: 0.08em;
  }

  /* MOBILE LOG TOGGLE */
  .log-toggle {
    display: none; position: fixed; bottom: 12px; right: 12px; z-index: 50;
    width: 44px; height: 44px; border-radius: 50%;
    background: #0f1520; border: 1px solid #1a2540;
    color: #4a90d9; font-size: 18px; cursor: pointer;
    box-shadow: 0 2px 12px #00000060;
    align-items: center; justify-content: center;
  }
  @media (max-width: 700px) {
    .log-panel { position: fixed; inset: 0; z-index: 90; width: 100%; transform: translateX(100%); transition: transform 0.3s ease; }
    .log-panel.open { transform: translateX(0); }
    .log-toggle { display: flex; }
    .log-close { display: block !important; }
  }

  /* ========================================= */
  /* REFERENCE POPUP - NATO PHONETIC ALPHABET  */
  /* ========================================= */
  .ref-fab {
    position: fixed; bottom: 12px; left: 12px; z-index: 50;
    width: 44px; height: 44px; border-radius: 50%;
    background: #0f1520; border: 1px solid #00e5a040;
    color: #00e5a0; font-size: 13px; font-weight: 700; cursor: pointer;
    box-shadow: 0 2px 12px #00000060, 0 0 12px #00e5a015;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Oswald', sans-serif; letter-spacing: 0.05em;
    transition: all 0.2s ease;
  }
  .ref-fab:hover { border-color: #00e5a080; box-shadow: 0 2px 16px #00000080, 0 0 20px #00e5a025; }

  .ref-overlay {
    position: fixed; inset: 0; z-index: 200;
    background: rgba(4, 6, 10, 0.85);
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    display: none; align-items: center; justify-content: center;
    padding: 16px;
  }
  .ref-overlay.open { display: flex; }

  .ref-popup {
    background: #0a0e14;
    border: 1px solid #1e2a3a;
    border-radius: 8px;
    width: 100%; max-width: 580px; max-height: 85vh;
    display: flex; flex-direction: column;
    box-shadow: 0 8px 40px #000000a0, 0 0 30px #00e5a008;
    overflow: hidden;
    animation: fadeSlideIn 0.25s ease;
  }

  .ref-popup-header {
    padding: 14px 16px; border-bottom: 1px solid #1e2a3a;
    display: flex; justify-content: space-between; align-items: center;
    background: linear-gradient(180deg, #0c1018, #0a0e14);
    position: relative; flex-shrink: 0;
  }
  .ref-popup-header::after {
    content: ''; position: absolute; bottom: -1px; left: 50%; transform: translateX(-50%);
    width: 80px; height: 1px; background: #00e5a0; box-shadow: 0 0 10px #00e5a0;
  }
  .ref-popup-title {
    font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 16px;
    letter-spacing: 0.1em; text-transform: uppercase; color: #edf2f7;
  }
  .ref-popup-title span { color: #00e5a0; }
  .ref-popup-sub {
    font-size: 7px; color: #5a6a7e; letter-spacing: 0.2em;
    text-transform: uppercase; margin-top: 2px;
  }
  .ref-close-btn {
    background: none; border: 1px solid #1e2a3a; border-radius: 4px;
    color: #5a6a7e; font-size: 16px; cursor: pointer; width: 30px; height: 30px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'JetBrains Mono', monospace; transition: all 0.2s;
  }
  .ref-close-btn:hover { border-color: #00e5a040; color: #00e5a0; }

  .ref-search-wrap {
    padding: 10px 16px; border-bottom: 1px solid #1e2a3a; flex-shrink: 0;
  }
  .ref-search {
    width: 100%; padding: 7px 10px 7px 30px;
    background: #111821; border: 1px solid #1e2a3a; border-radius: 4px;
    color: #edf2f7; font-family: 'JetBrains Mono', monospace; font-size: 12px;
    outline: none; transition: border-color 0.2s;
  }
  .ref-search::placeholder { color: #5a6a7e; }
  .ref-search:focus { border-color: #00e5a050; }
  .ref-search-icon {
    position: absolute; left: 26px; top: 50%; transform: translateY(-50%);
    color: #5a6a7e; font-size: 12px; pointer-events: none;
  }

  .ref-body { flex: 1; overflow-y: auto; padding: 12px 16px; }

  .ref-section-label {
    font-family: 'Oswald', sans-serif; font-weight: 300;
    font-size: 9px; letter-spacing: 0.35em; text-transform: uppercase;
    color: #5a6a7e; margin-bottom: 8px; margin-top: 12px;
  }
  .ref-section-label:first-child { margin-top: 0; }

  .ref-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 4px; margin-bottom: 8px;
  }
  .ref-item {
    display: flex; align-items: center; gap: 8px;
    padding: 5px 8px; background: #111821; border: 1px solid #1e2a3a;
    border-radius: 3px; transition: all 0.15s;
  }
  .ref-item:hover { background: #161e2a; border-color: #00e5a025; }
  .ref-item.hidden { display: none; }
  .ref-letter {
    font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 16px;
    color: #00e5a0; width: 20px; text-align: center; flex-shrink: 0;
    text-shadow: 0 0 14px rgba(0, 229, 160, 0.15);
  }
  .ref-divider { width: 1px; height: 18px; background: #1e2a3a; flex-shrink: 0; }
  .ref-word {
    font-family: 'Oswald', sans-serif; font-weight: 500; font-size: 12px;
    letter-spacing: 0.06em; text-transform: uppercase; color: #edf2f7;
  }
  .ref-digit-letter {
    font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 14px;
    color: #38bdf8; width: 16px; text-align: center; flex-shrink: 0;
  }
  .ref-digit-pron {
    font-size: 8px; color: #5a6a7e; margin-left: auto; letter-spacing: 0.04em;
  }
  .ref-footer {
    padding: 8px 16px; border-top: 1px solid #1e2a3a;
    font-size: 7px; color: #5a6a7e; letter-spacing: 0.15em;
    text-transform: uppercase; text-align: center; flex-shrink: 0;
  }

  .log-close { display: none; background: none; border: none; color: #4a5578; font-size: 18px; cursor: pointer; font-family: 'JetBrains Mono', monospace; }
</style>
</head>
<body>
<div class="scanline-overlay"></div>
<div class="app">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="header-dot"></div>
      <div>
        <div class="header-title">COMMS INTERFACE</div>
        <div class="header-sub">SECURE MULTI-CHANNEL AUDIO MONITORING</div>
      </div>
    </div>
    <div class="header-right">
      <div style="text-align:right">
        <div class="header-time" id="clock"></div>
        <div class="header-utc" id="utc"></div>
      </div>
      <div class="header-badge">ENCRYPTED</div>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <div class="channels-panel" id="channelsPanel">
      <div class="section-label-bar">
        <span>ACTIVE CHANNELS</span>
        <span class="line"></span>
        <span>6 ONLINE</span>
      </div>
      <div id="channelList"></div>
    </div>

    <!-- Log Panel -->
    <div class="log-panel" id="logPanel">
      <div class="log-header">
        <span>OPS LOG</span>
        <button class="log-close" id="logClose">&times;</button>
        <span class="log-blink">●</span>
      </div>
      <div class="log-body" id="logBody"></div>
      <div class="log-footer">
        <span>LATENCY: 12ms</span>
        <span>PKT LOSS: 0.00%</span>
        <span>AES-256</span>
      </div>
    </div>
  </div>
</div>

<!-- FLOATING BUTTONS -->
<button class="log-toggle" id="logToggle">☰</button>
<button class="ref-fab" id="refFab" title="NATO Phonetic Reference">Αα</button>

<!-- REFERENCE POPUP OVERLAY -->
<div class="ref-overlay" id="refOverlay">
  <div class="ref-popup">
    <div class="ref-popup-header">
      <div>
        <div class="ref-popup-title"><span>Phonetic</span> Alphabet</div>
        <div class="ref-popup-sub">ICAO / ITU / NATO — Quick Reference</div>
      </div>
      <button class="ref-close-btn" id="refClose">&times;</button>
    </div>
    <div class="ref-search-wrap" style="position:relative">
      <span class="ref-search-icon">⌕</span>
      <input class="ref-search" id="refSearch" type="text" placeholder="Filter..." autocomplete="off" />
    </div>
    <div class="ref-body">
      <div class="ref-section-label">Letters</div>
      <div class="ref-grid" id="refAlphaGrid"></div>
      <div class="ref-section-label">Digits — Pronunciation</div>
      <div class="ref-grid" id="refDigitGrid"></div>
    </div>
    <div class="ref-footer">ICAO Annex 10 • ITU Radio Regulations • NATO STANAG 7066</div>
  </div>
</div>

<script>
// ============================
// DATA
// ============================
const PARTICIPANTS = [
  { codename:"OPERATOR", role:"Local Mic", color:"#ff3366", freq:"LOCAL", isMic:true },
  { codename:"VIPER-6", role:"SIGINT Lead", color:"#00ff88", freq:"142.750 MHz" },
  { codename:"GHOST-3", role:"Cyber Ops", color:"#00d4ff", freq:"156.300 MHz" },
  { codename:"FALCON-9", role:"ISR Analyst", color:"#ff6b35", freq:"243.000 MHz" },
  { codename:"SHADOW-1", role:"Ground Team", color:"#c678dd", freq:"380.125 MHz" },
  { codename:"RAVEN-7", role:"ELINT Monitor", color:"#e5c07b", freq:"225.500 MHz" },
];

// Operational log messages — redacted style
const LOG_MESSAGES = [
  { from:"SYSTEM", action:"COMSEC key rotation", detail:"Cycle 0x4F2A complete", redacted:false, p:"system" },
  { from:"VIPER-6", action:"Microphone UNMUTED", detail:null, redacted:false, p:"normal" },
  { from:"GHOST-3", action:"Session authenticated", detail:"PKI cert verified", redacted:false, p:"normal" },
  { from:"FALCON-9", action:"SITREP filed", detail:"████████████████", redacted:true, p:"normal" },
  { from:"SHADOW-1", action:"Biometrics updated", detail:"████████████████", redacted:true, p:"normal" },
  { from:"SYSTEM", action:"Channel integrity check", detail:"All channels nominal", redacted:false, p:"system" },
  { from:"RAVEN-7", action:"Collection tasking ACK", detail:"████████████████", redacted:true, p:"normal" },
  { from:"VIPER-6", action:"Target package received", detail:"████████████████", redacted:true, p:"high" },
  { from:"GHOST-3", action:"Microphone MUTED", detail:null, redacted:false, p:"normal" },
  { from:"FALCON-9", action:"ISR feed linked", detail:"Sensor ID ███████", redacted:true, p:"normal" },
  { from:"SHADOW-1", action:"Position report filed", detail:"Grid ██████████", redacted:true, p:"normal" },
  { from:"SYSTEM", action:"Heartbeat — all nodes", detail:"6/6 responding", redacted:false, p:"system" },
  { from:"RAVEN-7", action:"ELINT log archived", detail:"████████████████", redacted:true, p:"normal" },
  { from:"VIPER-6", action:"SIGINT report submitted", detail:"████████████████", redacted:true, p:"high" },
  { from:"GHOST-3", action:"Exploit payload staged", detail:"████████████████", redacted:true, p:"high" },
  { from:"SYSTEM", action:"Session token refreshed", detail:"TTL 3600s", redacted:false, p:"system" },
  { from:"FALCON-9", action:"Microphone UNMUTED", detail:null, redacted:false, p:"normal" },
  { from:"SHADOW-1", action:"MEDEVAC request logged", detail:"████████████████", redacted:true, p:"high" },
  { from:"RAVEN-7", action:"Frequency scan complete", detail:"████ emitters catalogued", redacted:true, p:"normal" },
  { from:"VIPER-6", action:"Microphone MUTED", detail:null, redacted:false, p:"normal" },
  { from:"SYSTEM", action:"Bandwidth allocation adj.", detail:"QoS priority updated", redacted:false, p:"system" },
  { from:"GHOST-3", action:"Network map updated", detail:"████ nodes — ████████████", redacted:true, p:"normal" },
  { from:"FALCON-9", action:"SITREP filed", detail:"████████████████", redacted:true, p:"normal" },
  { from:"SHADOW-1", action:"Microphone UNMUTED", detail:null, redacted:false, p:"normal" },
  { from:"RAVEN-7", action:"Bearing update logged", detail:"███° — ████████", redacted:true, p:"normal" },
  { from:"SYSTEM", action:"TEMPEST compliance check", detail:"PASS", redacted:false, p:"system" },
  { from:"VIPER-6", action:"Geolocation fix pushed", detail:"████████████████", redacted:true, p:"high" },
  { from:"GHOST-3", action:"C2 beacon confirmed", detail:"████████████████", redacted:true, p:"high" },
];

const REDACT_NOTICES = [
  "AVAILABLE HIGHSIDE",
  "VIEW AT AUTHORISED TERMINAL",
  "CLASSIFIED — HIGHSIDE ONLY",
  "ACCESS VIA JWICS TERMINAL",
  "RESTRICTED — SEE AUTHORISED TERMINAL",
];

// ============================
// SIMULATED WAVEFORM
// ============================
class SimWave {
  constructor(intensity) {
    this.intensity = intensity || (0.4 + Math.random() * 0.5);
    this.phase = Math.random() * Math.PI * 2;
    this.noisePhase = Math.random() * 1000;
    this.speaking = false;
    this.speakT = 0; this.silenceT = 0;
    this.nextSpeak = Math.random() * 300 + 100;
    this.nextSilence = Math.random() * 200 + 60;
    this.volume = 0; this.targetVol = 0;
  }
  update() {
    this.phase += 0.08; this.noisePhase += 0.02;
    if (this.speaking) {
      this.speakT++;
      if (this.speakT > this.nextSilence) {
        this.speaking = false; this.silenceT = 0;
        this.nextSpeak = Math.random() * 400 + 150; this.targetVol = 0;
      }
    } else {
      this.silenceT++;
      if (this.silenceT > this.nextSpeak) {
        this.speaking = true; this.speakT = 0;
        this.nextSilence = Math.random() * 250 + 80;
        this.targetVol = Math.random() * 0.6 + 0.3;
      }
    }
    this.volume += (this.targetVol - this.volume) * 0.08;
  }
  getData(len) {
    const d = new Float32Array(len);
    for (let i = 0; i < len; i++) {
      const t = i / len;
      let v = Math.sin(this.phase + t * 12) * 0.3
            + Math.sin(this.phase * 1.7 + t * 28) * 0.2
            + Math.sin(this.phase * 0.5 + t * 6) * 0.15
            + (Math.random() - 0.5) * 0.4
            + Math.sin(this.noisePhase + t * 50) * 0.1;
      d[i] = v * this.volume * this.intensity;
    }
    return d;
  }
}

// ============================
// STATE
// ============================
const sims = {};
PARTICIPANTS.forEach(p => { if (!p.isMic) sims[p.codename] = new SimWave(); });

let micActive = false, audioCtx = null, analyser = null, micStream = null;
let micData = new Float32Array(128);
let logIdx = 0;

// ============================
// DOM REFS
// ============================
const channelList = document.getElementById('channelList');
const logBody = document.getElementById('logBody');
const clockEl = document.getElementById('clock');
const utcEl = document.getElementById('utc');
const logPanel = document.getElementById('logPanel');
const logToggle = document.getElementById('logToggle');
const logClose = document.getElementById('logClose');
const refFab = document.getElementById('refFab');
const refOverlay = document.getElementById('refOverlay');
const refClose = document.getElementById('refClose');
const refSearch = document.getElementById('refSearch');

// Log panel toggle (mobile)
logToggle.onclick = () => logPanel.classList.toggle('open');
logClose.onclick = () => logPanel.classList.remove('open');

// Reference popup
refFab.onclick = () => { refOverlay.classList.add('open'); refSearch.value = ''; filterRef(''); };
refClose.onclick = () => refOverlay.classList.remove('open');
refOverlay.onclick = (e) => { if (e.target === refOverlay) refOverlay.classList.remove('open'); };

// ============================
// BUILD NATO REFERENCE
// ============================
const alphabet = [
  ['A','Alpha'],['B','Bravo'],['C','Charlie'],['D','Delta'],
  ['E','Echo'],['F','Foxtrot'],['G','Golf'],['H','Hotel'],
  ['I','India'],['J','Juliet'],['K','Kilo'],['L','Lima'],
  ['M','Mike'],['N','November'],['O','Oscar'],['P','Papa'],
  ['Q','Quebec'],['R','Romeo'],['S','Sierra'],['T','Tango'],
  ['U','Uniform'],['V','Victor'],['W','Whiskey'],['X','X-ray'],
  ['Y','Yankee'],['Z','Zulu']
];
const digits = [
  ['0','Zero','ZE-RO'],['1','One','WUN'],['2','Two','TOO'],
  ['3','Tree','TREE'],['4','Fower','FOW-ER'],['5','Fife','FIFE'],
  ['6','Six','SIX'],['7','Seven','SEV-EN'],['8','Eight','AIT'],
  ['9','Niner','NIN-ER'],['.','Decimal','DAY-SEE-MAL']
];

const refAlphaGrid = document.getElementById('refAlphaGrid');
const refDigitGrid = document.getElementById('refDigitGrid');

alphabet.forEach(([letter, word]) => {
  const el = document.createElement('div');
  el.className = 'ref-item';
  el.dataset.letter = letter.toLowerCase();
  el.dataset.word = word.toLowerCase();
  el.innerHTML = `<div class="ref-letter">${letter}</div><div class="ref-divider"></div><div class="ref-word">${word}</div>`;
  refAlphaGrid.appendChild(el);
});

digits.forEach(([num, word, pron]) => {
  const el = document.createElement('div');
  el.className = 'ref-item';
  el.dataset.letter = num;
  el.dataset.word = word.toLowerCase();
  el.innerHTML = `<div class="ref-digit-letter">${num}</div><div class="ref-divider"></div><div class="ref-word">${word}</div><div class="ref-digit-pron">${pron}</div>`;
  refDigitGrid.appendChild(el);
});

function filterRef(q) {
  document.querySelectorAll('.ref-item').forEach(el => {
    const match = !q || el.dataset.letter.includes(q) || el.dataset.word.includes(q);
    el.classList.toggle('hidden', !match);
  });
}
refSearch.addEventListener('input', (e) => filterRef(e.target.value.toLowerCase().trim()));

// ============================
// BUILD CHANNEL CARDS
// ============================
const channels = {};
PARTICIPANTS.forEach(p => {
  const dim = p.color + '50';
  const card = document.createElement('div');
  card.className = 'channel-card';
  card.style.setProperty('--ch-color', p.color);
  card.style.setProperty('--ch-color-dim', dim);

  card.innerHTML = `
    <div class="accent"></div>
    <div class="ch-header">
      <div class="ch-left">
        <span class="status-dot" data-dot></span>
        <span class="codename" data-name>${p.codename}</span>
        ${p.isMic ? `<button class="mic-btn" data-mic>○ OFF</button>` : ''}
      </div>
      <div class="ch-right">
        <span class="ch-meta ch-freq">${p.freq}</span>
        <span class="ch-meta ch-role" style="color:${dim}">${p.role}</span>
      </div>
    </div>
    <div class="waveform-wrap"><canvas data-glow></canvas><canvas data-wave></canvas></div>
    <div class="level-meter"><div class="level-fill" data-level></div></div>
  `;

  if (p.isMic) {
    card.querySelector('[data-mic]').addEventListener('click', toggleMic);
  }
  channelList.appendChild(card);
  if (p.isMic) {
    const sep = document.createElement('div');
    sep.className = 'separator';
    channelList.appendChild(sep);
  }

  channels[p.codename] = {
    card, p,
    dot: card.querySelector('[data-dot]'),
    nameEl: card.querySelector('[data-name]'),
    glowCanvas: card.querySelector('[data-glow]'),
    waveCanvas: card.querySelector('[data-wave]'),
    levelEl: card.querySelector('[data-level]'),
    micBtn: card.querySelector('[data-mic]'),
  };
});

// ============================
// MIC
// ============================
async function toggleMic() {
  const ch = channels['OPERATOR'];
  if (micActive) {
    if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
    if (audioCtx) { audioCtx.close(); audioCtx = null; analyser = null; }
    micActive = false; micData = new Float32Array(128);
    ch.micBtn.textContent = '○ OFF'; ch.micBtn.classList.remove('live');
    addLog({ from:"OPERATOR", action:"Microphone MUTED", detail:null, redacted:false, p:"normal" });
    return;
  }
  try {
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioCtx = new AudioContext();
    const src = audioCtx.createMediaStreamSource(micStream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    src.connect(analyser);
    micActive = true;
    ch.micBtn.textContent = '● LIVE'; ch.micBtn.classList.add('live');
    addLog({ from:"OPERATOR", action:"Microphone ACTIVATED", detail:"Local device audio stream", redacted:false, p:"high" });
  } catch(e) {
    console.warn('Mic denied', e);
    addLog({ from:"SYSTEM", action:"Mic access DENIED", detail:"Permission rejected by device", redacted:false, p:"high" });
  }
}

// ============================
// DRAW WAVEFORM
// ============================
function drawWave(ch, data) {
  const wrap = ch.waveCanvas.parentElement;
  const w = wrap.clientWidth;
  const h = wrap.clientHeight;
  if (w === 0 || h === 0) return;
  const dpr = window.devicePixelRatio || 1;

  [ch.glowCanvas, ch.waveCanvas].forEach(c => {
    c.width = w * dpr; c.height = h * dpr;
    c.style.width = w + 'px'; c.style.height = h + 'px';
  });

  const color = ch.p.color;
  const rms = Math.sqrt(data.reduce((s, v) => s + v * v, 0) / data.length);
  const isActive = rms > 0.03;
  const mid = h / 2;
  const amp = h * 0.38;

  ch.dot.className = 'status-dot' + (isActive ? ' active' : '');
  ch.nameEl.className = 'codename' + (isActive ? ' glow' : '');
  ch.card.className = 'channel-card' + (isActive ? ' active' : '');

  const db = rms > 0 ? Math.max(-60, 20 * Math.log10(rms)) : -60;
  const pct = Math.max(0, Math.min(100, ((db + 60) / 60) * 100));
  ch.levelEl.style.width = pct + '%';
  ch.levelEl.style.boxShadow = pct > 60 ? `0 0 6px ${color}80` : 'none';

  // Glow
  const gctx = ch.glowCanvas.getContext('2d');
  gctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  gctx.clearRect(0, 0, w, h);
  gctx.strokeStyle = color; gctx.lineWidth = 6;
  gctx.globalAlpha = 0.15; gctx.filter = 'blur(4px)';
  gctx.beginPath();
  for (let i = 0; i < data.length; i++) {
    const x = (i / data.length) * w;
    const y = mid + data[i] * amp;
    i === 0 ? gctx.moveTo(x, y) : gctx.lineTo(x, y);
  }
  gctx.stroke(); gctx.filter = 'none'; gctx.globalAlpha = 1;

  // Main
  const ctx = ch.waveCanvas.getContext('2d');
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ctx.clearRect(0, 0, w, h);

  ctx.strokeStyle = color + '08'; ctx.lineWidth = 0.5;
  for (let y = 0; y < h; y += h / 6) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
  }

  ctx.strokeStyle = color; ctx.lineWidth = 1.5;
  ctx.shadowColor = color; ctx.shadowBlur = isActive ? 8 : 2;
  ctx.beginPath();
  for (let i = 0; i < data.length; i++) {
    const x = (i / data.length) * w;
    const y = mid + data[i] * amp;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  }
  ctx.stroke(); ctx.shadowBlur = 0;

  ctx.strokeStyle = color + '20'; ctx.lineWidth = 0.5;
  ctx.beginPath(); ctx.moveTo(0, mid); ctx.lineTo(w, mid); ctx.stroke();
}

// ============================
// CLOCK
// ============================
function updateClock() {
  const now = new Date();
  clockEl.textContent = now.toLocaleTimeString('en-GB', { hour12: false });
  utcEl.textContent = now.toISOString().replace('T', ' ').split('.')[0] + 'Z';
}

// ============================
// OPS LOG
// ============================
function getColor(name) {
  const p = PARTICIPANTS.find(x => x.codename === name);
  return p ? p.color : '#4a90d9';
}

function addLog(m) {
  const now = new Date();
  const fromColor = m.from === 'SYSTEM' ? '#4a90d9' : getColor(m.from);
  const borderColor = m.p === 'high' ? '#ff6b35' : (m.from === 'SYSTEM' ? '#4a90d960' : fromColor + '40');

  const el = document.createElement('div');
  el.className = 'log-entry';
  el.style.setProperty('--log-color', borderColor);

  let detailHtml = '';
  if (m.redacted && m.detail) {
    const notice = REDACT_NOTICES[Math.floor(Math.random() * REDACT_NOTICES.length)];
    detailHtml = `<div class="log-msg"><span class="redact-bar">${m.detail}</span></div>
                  <div class="log-redacted">⬡ ${notice}</div>`;
  } else if (m.detail) {
    detailHtml = `<div class="log-msg">${m.detail}</div>`;
  }

  el.innerHTML = `
    <div class="log-top">
      <span class="log-from" style="color:${fromColor}">${m.from}</span>
      <span class="log-time">${now.toLocaleTimeString('en-GB',{hour12:false})}</span>
    </div>
    <div class="log-msg" style="color:#c8d0e0;font-weight:500">${m.action}</div>
    ${detailHtml}
  `;
  logBody.prepend(el);
  while (logBody.children.length > 20) logBody.removeChild(logBody.lastChild);
}

// Seed initial logs
addLog(LOG_MESSAGES[0]);
addLog(LOG_MESSAGES[1]);
addLog(LOG_MESSAGES[2]);

// Auto log feed
setInterval(() => {
  logIdx = (logIdx + 3) % LOG_MESSAGES.length;
  addLog(LOG_MESSAGES[logIdx]);
}, 3500 + Math.random() * 2000);

// ============================
// MAIN LOOP
// ============================
function tick() {
  updateClock();
  Object.entries(sims).forEach(([name, sim]) => {
    sim.update();
    drawWave(channels[name], sim.getData(128));
  });

  if (micActive && analyser) {
    const buf = new Float32Array(analyser.frequencyBinCount);
    analyser.getFloatTimeDomainData(buf);
    micData = buf;
  } else {
    micData = new Float32Array(128);
  }
  drawWave(channels['OPERATOR'], micData);

  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);

// ============================
// SERVICE WORKER + PWA
// ============================
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js')
    .then(reg => console.log('SW registered:', reg.scope))
    .catch(err => console.warn('SW failed:', err));
}

let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const banner = document.createElement('div');
  banner.style.cssText = `
    position:fixed;bottom:60px;left:50%;transform:translateX(-50%);z-index:200;
    background:#0f1520;border:1px solid #00d4ff40;border-radius:8px;
    padding:10px 16px;display:flex;align-items:center;gap:12px;
    box-shadow:0 4px 20px #00000080;font-family:'JetBrains Mono',monospace;
  `;
  banner.innerHTML = `
    <span style="font-size:11px;color:#c8d0e0;letter-spacing:0.05em">Install as app?</span>
    <button id="installBtn" style="background:#00d4ff20;border:1px solid #00d4ff60;border-radius:4px;padding:4px 12px;color:#00d4ff;font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;cursor:pointer;letter-spacing:0.1em;">INSTALL</button>
    <button id="installDismiss" style="background:none;border:none;color:#4a5578;font-size:16px;cursor:pointer;font-family:'JetBrains Mono',monospace;">&times;</button>
  `;
  document.body.appendChild(banner);
  document.getElementById('installBtn').onclick = async () => {
    deferredPrompt.prompt(); await deferredPrompt.userChoice;
    deferredPrompt = null; banner.remove();
  };
  document.getElementById('installDismiss').onclick = () => banner.remove();
});
</script>
</body>
</html>
